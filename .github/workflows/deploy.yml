name: deploy

on:
    push:
        branches:
            - main

permissions:
    id-token: write
    contents: read
    packages: read

jobs:
    deploy:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                environment: ['dev', 'staging', deploy-prod-unsafe]

        environment: ${{ matrix.environment }}

        steps:

            - name: deploy
              run: echo "Deploying to $DEPLOY_ENVIRONMENT"
              env:
                  DEPLOY_ENVIRONMENT: ${{ matrix.environment }}

    deploy-prod-safe:
        runs-on: ubuntu-latest
        environment: prod-safe

        steps:
          - name: Get last successful staging deployment
            id: staging
            run: |
              SHA=$(gh api \
                repos/${{ github.repository }}/deployments \
                --jq '.[] | select(.environment=="staging") | .sha' | head -n 1)

              echo "sha=$SHA" >> $GITHUB_OUTPUT
            env:
              GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Ensure prod deploy matches staging
            run: |
              if [ "${{ github.sha }}" != "${{ steps.staging.outputs.sha }}" ]; then
                echo "‚ùå Production must deploy the same commit as staging"
                echo "Staging: ${{ steps.staging.outputs.sha }}"
                echo "Prod:    ${{ github.sha }}"
                exit 1
              fi

          - name: deploy
            run: echo "Deploying to prod (safe)"
            env:
                DEPLOY_ENVIRONMENT: prod-safe
